<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaIM</title>
    <script src="./libs/jq.js"></script>
    <style>
        .container {
            display: fixed;
            width: 100%;
            height: 100vh;
            left: 0;
            top: 0;
        }

        .layout-left {
            left: 0;
            width: 64px;
            background-color: #191919;
        }

        body {
            padding: 0;
            margin: 0;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 16%;
        }

        .my-avatar {
            width: 36px;
            height: 36px;
            margin-left: 14px;
            box-sizing: border-box;
        }

        .layout-middle {
            width: 240px;
            left: 64px;
            background-color: #1B1B1B;
        }

        .layout {
            position: fixed;
            top: 0;
            height: 100%;
        }

        * {
            color: #fff;
            font-family: 'Noto Sans', sans-serif;
        }

        .layout-right {
            left: 304px;
            right: 0;
            background-color: #111111;
        }

        .session-card {
            height: 72px;
            padding: 16px;
            box-sizing: border-box;
        }

        .session-card .session-info {
            height: 72px;
            position: relative;
            display: flex;
            top: -64px;
            left: 56px;
            flex-direction: column;
            justify-content: center;
        }

        .session-info .session-name {
            font-size: 16px;
        }

        .session-info .session-last-message {
            font-size: 12px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 160px;
        }

        .session-card:hover {
            background-color: #2D2D2D;
        }

        .chat-area-header {
            height: 48px;
            padding: 16px;
            box-sizing: border-box;
            border-bottom: 1px solid #2D2D2D;
        }

        .chat-area-header .session-name {
            font-size: 16px;
            font-weight: bold;
        }

        .session-card.selected {
            background-color: #4F4F4F;
        }

        .message-card {
            padding: 8px 16px;
            box-sizing: border-box;
            display: flex;
            align-items: flex-start;
        }

        .message-card:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .message-card .avatar {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .message-card .message-body {
            margin-left: 8px;
            flex-grow: 1;
            min-width: 0;
        }

        .message-card .message-body .username {
            opacity: 0.8;
        }

        .message-card .message-body .message-content {
            word-wrap: break-word;
            white-space: normal;
        }

        .layout-right .mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111111;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .layout-left-bottom {
            position: absolute;
            bottom: 16px;
            width: 100%;
            text-align: center;
        }

        .layout-left-bottom .btn {
            width: 40px;
            height: 40px;
            padding: 8px;
            box-sizing: border-box;
            cursor: pointer;
            border-radius: 16%;
        }

        .layout-left-bottom .btn-logout:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .chat-area-bottom {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 144px;
            box-sizing: border-box;
            border-top: 1px solid #2D2D2D;
            display: flex;
        }

        .chat-area-bottom textarea {
            width: 100%;
            height: calc(100% - 48px);
            background-color: rgba(0, 0, 0, 0);
            border: none;
            resize: none;
            padding: 0px 16px;
            box-sizing: border-box;
            outline: none;
        }

        .chat-area-bottom textarea:focus {
            outline: none;
        }

        .chat-area-bottom .btn-send {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background-color: #0066CC;
            padding: 4px 16px;
            border-radius: 4px;
            box-sizing: border-box;
            cursor: pointer;
        }

        .chat-area-content {
            height: calc(100% - 144px);
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="layout-left layout">
            <img src="/assets/logo.svg" alt="logo" width="64" height="64" style="padding: 8px;box-sizing: border-box;">
            <img class="avatar my-avatar">
            <div class="layout-left-bottom">
                <img src="./assets/icons/logout.svg" class="btn btn-logout" title="Logout">
            </div>
        </div>
        <div class="layout-middle layout"></div>
        <div class="layout-right layout">
            <div class="chat-area-header">
                <div class="session-name">Session Name</div>
            </div>
            <div class="chat-area-content"></div>
            <div class="chat-area-bottom">
                <textarea class="chat-input" placeholder="Type a message..." maxlength="1024"></textarea>
                <div class="btn-send">Send</div>
            </div>
            <div class="mask">
                <img src="/assets/logo.svg">&nbsp;Select a session on the left to start chatting
            </div>
        </div>
    </div>
    <div style="display: none;" class="template">
        <div class="template-session-card">
            <div class="session-card">
                <img class="avatar">
                <div class="session-info">
                    <div class="session-name"></div>
                    <div class="session-last-message"></div>
                </div>
            </div>
        </div>
        <div class="template-message-card">
            <div class="message-card">
                <img class="avatar">
                <div class="message-body">
                    <div class="username"></div>
                    <div class="message-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var curSession = null;
        const messageHistory = {};
        const userCache = {};
        const template = {
            sessionCard: $(".template-session-card .session-card").clone(),
            messageCard: $(".template-message-card .message-card").clone(),
        }
        const sessionList = {
            selectedSession: null,
            add: function (name, lastMessage, lastTimestamp = 0) {
                const sessionName = {
                    type: name.split(":")[0],
                    name: name.split(":")[1],
                }
                const existedSessionCard = $(".session-card").filter(function () {
                    return $(this).find(".session-name").text() === sessionName.name;
                });

                if (existedSessionCard.length > 0) {
                    existedSessionCard.attr("data-timestamp", lastTimestamp);
                    existedSessionCard.attr("data-session-name", name);
                    existedSessionCard.find(".session-last-message").text(lastMessage);
                } else {
                    const sessionCard = template.sessionCard.clone();
                    sessionCard.find(".avatar").attr("src", `./api/get_avatar?name=${sessionName.name}:${sessionName.type}`);
                    sessionCard.find(".session-name").text(sessionName.name);
                    sessionCard.find(".session-last-message").text(lastMessage);
                    sessionCard.attr("data-timestamp", lastTimestamp);
                    sessionCard.attr("data-session-name", name);
                    $(".layout-middle").append(sessionCard);
                    sessionCard.click(function () {
                        sessionList.selectSession(sessionCard);
                    });
                }

                this.sortByTimestamp();
            },

            sortByTimestamp: function () {
                const container = $(".layout-middle");
                const cards = container.find(".session-card").get();

                cards.sort(function (a, b) {
                    const timeA = parseInt($(a).attr("data-timestamp")) || 0;
                    const timeB = parseInt($(b).attr("data-timestamp")) || 0;
                    return timeB - timeA;
                });

                $.each(cards, function (index, card) {
                    container.append(card);
                });
            },
            selectSession: function (sessionCard) {
                if (this.selectedSession && this.selectedSession.attr("data-session-name") === sessionCard.attr("data-session-name")) {
                    return;
                }

                if (this.selectedSession && curSession) {
                    const sessionKey = `${curSession.type}:${curSession.name}`;
                    messageHistory[sessionKey] = $(".chat-area-content").html();
                }

                if (this.selectedSession) {
                    this.selectedSession.removeClass("selected");
                }
                this.selectedSession = sessionCard;
                this.selectedSession.addClass("selected");
                const sessionName = this.selectedSession.attr("data-session-name");
                chatArea.setSession(sessionName);
            }
        }

        const userInfo = {
            get: function (uid, callback) {
                if (userCache[uid]) {
                    callback(userCache[uid]);
                    return;
                }

                $.get('/api/user_public_info?uid=' + uid, (data) => {
                    if (data.user) {
                        userCache[uid] = data.user;
                        callback(data.user);
                    }
                }).fail(() => {
                    callback({ username: 'Unknown', nickname: 'Unknown User' });
                });
            }
        };

        const chatArea = {
            setSession: function (sessionName) {
                if (!sessionName) return;

                curSession = {
                    type: sessionName.split(":")[0],
                    name: sessionName.split(":")[1],
                }
                $(".chat-area-header .session-name").text(curSession.name);

                const sessionKey = `${curSession.type}:${curSession.name}`;
                if (messageHistory[sessionKey]) {
                    $(".chat-area-content").html(messageHistory[sessionKey]);
                } else {
                    $(".chat-area-content").empty();
                }

                $(".mask").hide();
            },
            addMessage: function (uid, message, timestamp = 0) {
                userInfo.get(uid, (user) => {
                    const messageCard = template.messageCard.clone();
                    messageCard.find(".avatar").attr("src", `./api/get_avatar?name=${user.username}`);
                    messageCard.find(".username").text(user.nickname || user.username);
                    messageCard.find(".message-content").text(message);
                    messageCard.attr("data-timestamp", timestamp);
                    $(".chat-area-content").append(messageCard);

                    $(".chat-area-content").scrollTop($(".chat-area-content")[0].scrollHeight);
                });
            }
        }

        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i].trim();
                if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
            }
            return "";
        }

        const wsUtil = {
            init: function () {
                this.ws = new WebSocket(`ws://${window.location.hostname}:3001`);
                this.ws.onopen = () => {
                    console.log("Connected to WebSocket server");
                };
                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    if (message.type === "new_message") {
                        console.log(message);
                        const sessionKey = message.session;

                        if (curSession && `${curSession.type}:${curSession.name}` === sessionKey) {
                            chatArea.addMessage(message.from, message.message, message.timestamp);
                        }

                        sessionList.add(sessionKey, message.message, message.timestamp);

                        if (!messageHistory[sessionKey]) {
                            messageHistory[sessionKey] = '';
                        }
                        userInfo.get(message.from, (user) => {
                            const messageCard = template.messageCard.clone();
                            messageCard.find(".avatar").attr("src", `./api/get_avatar?name=${user.username}`);
                            messageCard.find(".username").text(user.nickname || user.username);
                            messageCard.find(".message-content").text(message.message);
                            messageCard.attr("data-timestamp", message.timestamp);
                            messageHistory[sessionKey] += messageCard[0].outerHTML;
                        });
                    }
                };
                this.ws.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };
                this.ws.onclose = () => {
                    console.log("Disconnected from WebSocket server");
                };
            }
        }

        const sender = {
            send: function (session, message) {
                if (typeof session === 'string') {
                    session = {
                        type: session.split(':')[0],
                        name: session.split(':')[1],
                    }
                }
                if (!wsUtil.ws || wsUtil.ws.readyState !== WebSocket.OPEN) {
                    console.error("WebSocket is not connected.");
                    return;
                }
                wsUtil.ws.send(JSON.stringify({
                    type: 'send_message',
                    session: `${session.type}:${session.name}`,
                    message: message
                }));
            },
        }

        window.onload = function () {
            $.getJSON('/api/user', (data) => {
                if (data.success) {
                    $(".my-avatar").attr("src", `/api/get_avatar?name=${data.user.username}`);
                }
            }).fail(() => {
            });

            $('.btn-logout').click(() => {
                $.post('/api/logout', {}, (data) => {
                    if (data.success) {
                        window.location.href = '/login';
                    }
                }).fail(() => {
                });
            })

            $('.btn-send').click(() => {
                const message = $('.chat-input').val() ? $('.chat-input').val() : $('.chat-input').text();
                if (message.trim() === '' || !curSession) {
                    return;
                }
                sender.send(curSession, message);
                $('.chat-input').val('');
            });

            wsUtil.init();
            sessionList.add("chat:public", "");
        }
    </script>
</body>

</html>